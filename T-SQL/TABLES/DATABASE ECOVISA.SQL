CREATE DATABASE ECOVISA;

USE ECOVISA;

--07/02/2025	BROSALES SE MODIFICA TBLSUCURSAL_EMPLEADO AGREGANDO CAMPO ESTADO
ALTER TABLE TBLSUCURSAL_EMPLEADO
ADD ESTADO BIT NOT NULL CONSTRAINT CK_HISTORIALEMPLEADO CHECK (ESTADO IN (0, 1));

--07/02/2025	BROSALES SE MODIFICA TBLEMPLEADO CAMPO SEGUNDO_NOMBRE ACEPTA NULL
ALTER TABLE TBLSUCURSAL_EMPLEADO
ALTER COLUMN SEGUNDO_NOMBRE VARCHAR(50) NULL;

--07/02/2025	BROSALES SE MODIFICA TBLEMPLEADO CAMPO SEGUNDO_APELLIDO ACEPTA NULL
ALTER TABLE TBLSUCURSAL_EMPLEADO
ALTER COLUMN SEGUNDO_APELLIDO VARCHAR(50) NULL;


--ADMINISTRACION
CREATE TABLE TBLDEPARTAMENTO(
	ID	INTEGER NOT NULL PRIMARY KEY,
	DESCRIPCION VARCHAR(100) NOT NULL,
	ESTADO BIT NOT NULL
);
GO


CREATE TABLE TBLCARGO(
	ID	INTEGER NOT NULL PRIMARY KEY,
	DESCRIPCION VARCHAR(100) NOT NULL,
	ESTADO BIT NOT NULL
);
GO


CREATE TABLE TBLEMPLEADO(
	ID INT NOT NULL PRIMARY KEY,
	PRIMER_NOMBRE VARCHAR(50) NOT NULL,
	SEGUNDO_NOMBRE VARCHAR(50) NULL,
	PRIMER_APELLIDO VARCHAR(50) NOT NULL,
	SEGUNDO_APELLIDO VARCHAR(50) NULL,
	CEDULA  VARCHAR(15) NOT NULL UNIQUE,
	DOMICILIO VARCHAR(300), 
	TELEFONO INT,
	CORREO_ELECTRONICO VARCHAR(100), 
	ESTADO BIT NOT NULL CONSTRAINT CK_ESTADO_EMPLEADO CHECK (ESTADO IN (0, 1)),
	IDDEPARTAMENTO_LABORAL INT NOT NULL,
	IDCARGO INT NOT NULL,
	CONSTRAINT FKEMPLEADO_DEPTO FOREIGN KEY (IDDEPARTAMENTO_LABORAL) REFERENCES TBLDEPARTAMENTO(ID),
	CONSTRAINT FKEMPLEADO_CARGO FOREIGN KEY (IDCARGO) REFERENCES TBLCARGO(ID)
);
GO


CREATE TABLE TBLSUCURSAL
(
	ID INTEGER NOT NULL,
	NOMBRE VARCHAR(100) NOT NULL,
	DIRECCION VARCHAR(300) NULL,
	ESTADO BIT NOT NULL	CONSTRAINT CK_ESTADO_SUCURSAL CHECK (ESTADO IN (0, 1))
	CONSTRAINT PK_SUCURSAL PRIMARY KEY (ID)
);
GO


CREATE TABLE TBLSUCURSAL_EMPLEADO
(
	IDSUCURSAL INTEGER NOT NULL,
	IDEMPLEADO INTEGER NOT NULL,
	FECHA_INGRESO DATE NOT NULL,
	CONSTRAINT PK_SUCURSAL_EMPLEADO PRIMARY KEY(IDSUCURSAL, IDEMPLEADO, FECHA_INGRESO),
	CONSTRAINT FK_SUCURSALEMPLEADO_SUCURSAL FOREIGN KEY (IDSUCURSAL) REFERENCES TBLSUCURSAL(ID),
	CONSTRAINT FK_SUCURSALEMPLEADO_EMPLEADO FOREIGN KEY (IDEMPLEADO) REFERENCES TBLEMPLEADO(ID)
);
GO


--Configuracion
CREATE TABLE TBLGRUPO(
	ID	INTEGER NOT NULL PRIMARY KEY,
	DESCRIPCION VARCHAR(100) NOT NULL,
	ESTADO BIT NOT NULL	
);
GO


CREATE TABLE TBLUSUARIO(
	ID	INTEGER NOT NULL PRIMARY KEY,
	NOMBREUSUARIO VARCHAR(200) NOT NULL,
	USUARIO	VARCHAR(30) NOT NULL,
	CONTRASENA VARCHAR(100) NOT NULL, 
	CORREO_ELECTRONICO VARCHAR(100) NOT NULL,
	ESTADO BIT NOT NULL	CONSTRAINT CK_ESTADO_USUARIO CHECK (ESTADO IN (0, 1)),
	IDEMPLEADO INTEGER NOT NULL,
	IDGRUPO INTEGER NOT NULL,
	CONSTRAINT FKUSUARIO_EMPLEADO FOREIGN KEY (IDEMPLEADO) REFERENCES TBLEMPLEADO(ID),
	CONSTRAINT FKUSUARIO_GRUPO FOREIGN KEY (IDGRUPO) REFERENCES TBLGRUPO(ID),
);
GO


CREATE TABLE TBLMENU(
	ID INT NOT NULL,
	NOMBREMENU VARCHAR(200) NOT NULL,
	UBICACION VARCHAR(500),
	POSICION INT NOT NULL,
	IDPADRE INT NOT NULL,
	CONSTRAINT PK_MENU PRIMARY KEY (ID),
	CONSTRAINT FK_MENU_MENU FOREIGN KEY (IDPADRE) REFERENCES TBLMENU(ID)
);
GO


CREATE TABLE TBLMENU_GRUPO
(
	ID INTEGER NOT NULL,
	IDMENU INTEGER NOT NULL,
	IDGRUPO INTEGER NOT NULL,
	CONSTRAINT PK_MENU_GRUPO PRIMARY KEY (ID),
	CONSTRAINT FK_MENUGRUPO_MENU FOREIGN KEY (IDMENU) REFERENCES TBLMENU(ID),
	CONSTRAINT FK_MENUGRUPO_GRUPO FOREIGN KEY (IDMENU) REFERENCES TBLGRUPO(ID)
);
GO


CREATE TABLE TBLMENU_USUARIO
(
	ID INTEGER NOT NULL,
	IDMENU INTEGER NOT NULL,
	IDUSUARIO INTEGER NOT NULL,
	CONSTRAINT PK_MENU_USUARIO PRIMARY KEY (ID),
	CONSTRAINT FK_MENUUSUARIO_MENU FOREIGN KEY (IDMENU) REFERENCES TBLMENU(ID),
	CONSTRAINT FK_MENUUSUARIO_USUARIO FOREIGN KEY (IDUSUARIO) REFERENCES TBLUSUARIO(ID)
);
GO


--CATALOGOS
CREATE TABLE TBLPROVEEDOR
(
	ID INTEGER NOT NULL,
	NOMBRE VARCHAR(100) NOT NULL,
	DIRECCION VARCHAR(300) NULL,
	TELEFONO INTEGER NULL,
	CORREO_ELECTRONICO VARCHAR(100) NULL,
	ESTADO BIT NOT NULL	CONSTRAINT CK_PROVEEDOR CHECK (ESTADO IN (0, 1)),
	CONSTRAINT PK_PROVEEDOR PRIMARY KEY(ID)
);
GO


CREATE TABLE TBLLABORATORIO
(
	ID INTEGER NOT NULL,
	NOMBRE VARCHAR(100) NOT NULL,
	ESTADO BIT NOT NULL	CONSTRAINT CK_ESTADO_LAB CHECK (ESTADO IN (0, 1)),
	CONSTRAINT PK_LABORATORIO PRIMARY KEY (ID)
);
GO


CREATE TABLE TBLCATEGORIA
(
	ID INTEGER NOT NULL,
	NOMBRE VARCHAR(100) NOT NULL,
	DESCRIPCION VARCHAR(300) NULL,
	ESTADO BIT NOT NULL	CONSTRAINT CK_ESTADO_CATEGORIA CHECK (ESTADO IN (0, 1)),
	CONSTRAINT PK_CATEGORIA PRIMARY KEY (ID)
);
GO


CREATE TABLE TBLTIPO_EMPAQUE
(
	ID INTEGER NOT NULL,
	NOMBRE VARCHAR(100) NOT NULL,
	DESCRIPCION VARCHAR(300) NULL,
	ESTADO BIT NOT NULL	CONSTRAINT CK_ESTADO_TIPOEMPAQUE CHECK (ESTADO IN (0, 1)),
	CONSTRAINT PK_TIPOEMPAQUE PRIMARY KEY (ID)
);
GO


--CLIENTES
CREATE TABLE TBLCLIENTE
(
	ID INTEGER NOT NULL,
	PRIMER_NOMBRE VARCHAR(50) NOT NULL,
	SEGUNDO_NOMBRE VARCHAR(50) NULL,
	PRIMER_APELLIDO VARCHAR(50) NOT NULL,
	SEGUNDO_APELLIDO VARCHAR(50) NULL,
	CEDULA VARCHAR(15) NULL,
	TELEFONO INTEGER NULL,
	CORREO_ELECTRONICO VARCHAR(100) NULL,
	DOMICILIO VARCHAR(300) NULL,
	CONSTRAINT PK_CLIENTE PRIMARY KEY (ID)
);
GO


--INVENTARIO
CREATE TABLE TBLPRODUCTO
(
	ID INTEGER NOT NULL,
	NOMBRE VARCHAR (100) NOT NULL,
	NOMBRE_ATERNATIVO VARCHAR (100) NOT NULL,
	DESCRIPCION VARCHAR (500) NOT NULL,
	STOCK_MAX INTEGER NOT NULL,
	STOCK_MINIMO INTEGER NOT NULL,
	IMGPRESENTACION VARCHAR(1000) NULL,
	ESTADO BIT NOT NULL	CONSTRAINT CK_ESTADO_PRODUCTO CHECK (ESTADO IN (0, 1)),
	IDCATEGORIA INTEGER NOT NULL,
	IDTIPO_EMPAQUE INTEGER NOT NULL,
	IDLABORATORIO INTEGER NOT NULL,
	CONSTRAINT PK_PRODUCTO PRIMARY KEY (ID),
	CONSTRAINT FK_PRODUCTO_CATEGORIA FOREIGN KEY (IDCATEGORIA) REFERENCES TBLCATEGORIA(ID),
	CONSTRAINT FK_PRODUCTO_TIPOEMPAQUE FOREIGN KEY (IDTIPO_EMPAQUE) REFERENCES TBLTIPO_EMPAQUE(ID),
	CONSTRAINT FK_PRODUCTO_LABORATORIO FOREIGN KEY (IDLABORATORIO) REFERENCES TBLLABORATORIO(ID)
);
GO

CREATE TABLE TBLPRECIO_PRODUCTO
(
	ID INTEGER NOT NULL,
	PRECIO_UNITARIO MONEY NOT NULL,
	FECHA DATE NOT NULL,
	DESCUENTO MONEY NOT NULL,
	ESTADO BIT NOT NULL	CONSTRAINT CK_ESTADO_PRECIOPRODUCTO CHECK (ESTADO IN (0, 1)),
	IDPRODUCTO INTEGER NOT NULL,
	CONSTRAINT PK_PRECIOPRODUCTO PRIMARY KEY (ID),
	CONSTRAINT FK_PRECIOPRODUCTO_PRODUCTO FOREIGN KEY (IDPRODUCTO) REFERENCES TBLPRODUCTO(ID)
);
GO

CREATE TABLE TBLLOTE
(
	ID INTEGER NOT NULL,
	REFERENCIA_LOTE VARCHAR(50) NOT NULL,
	FECHA_FABRICACION DATE NOT NULL,
	FECHA_VENCIMIENTO DATE NOT NULL,
	CODIGO_BARRA DATE NULL,
	PRECIO_COMPRA MONEY NOT NULL,
	IDPRODUCTO INTEGER NOT NULL,
	IDPROVEEDOR INTEGER NOT NULL,
	CONSTRAINT PK_LOTE PRIMARY KEY (ID, IDPRODUCTO),
	CONSTRAINT FK_LOTE_PRODUCTO FOREIGN KEY (IDPRODUCTO) REFERENCES TBLPRODUCTO(ID),
	CONSTRAINT FK_LOTE_PROVEEDOR FOREIGN KEY (IDPROVEEDOR) REFERENCES TBLPROVEEDOR(ID)	
);
GO


CREATE TABLE TBLINVENTARIO
(
	ID INTEGER NOT NULL,
	CANTIDAD_INICIAL INTEGER NOT NULL,
	CANTIDAD_ACTUAL INTEGER NOT NULL,
	FECHA_RECEPCION DATE NOT NULL,
	IDSUCURSAL INTEGER NOT NULL,
	IDLOTE INTEGER NOT NULL,
	IDPRODUCTO INTEGER NOT NULL,
	CONSTRAINT PK_INVENTARIO PRIMARY KEY (ID),
	CONSTRAINT FK_INVENTARIO_SUCURSAL FOREIGN KEY (IDSUCURSAL) REFERENCES TBLSUCURSAL(ID),
	CONSTRAINT FK_INVENTARIO_LOTE FOREIGN KEY (IDLOTE, IDPRODUCTO) REFERENCES TBLLOTE(ID, IDPRODUCTO)
);
GO


--VENTAS
CREATE TABLE TBLVENTA
(
	ID INTEGER NOT NULL,
	FECHA DATETIME NOT NULL,
	SUBTOTAL MONEY NOT NULL, 
	TOTAL MONEY NOT NULL,
	MONTO_PAGO MONEY NOT NULL,
	MONTO_VUELTO MONEY NOT NULL,
	IDUSUARIOREGISTRO INTEGER NOT NULL,
	IDSUCURSAL INTEGER NOT NULL,
	IDCLIENTE INTEGER NOT NULL,
	CONSTRAINT PK_VENTA_ PRIMARY KEY (ID),
	CONSTRAINT FK_VENTA_USUARIO FOREIGN KEY (IDUSUARIOREGISTRO) REFERENCES TBLUSUARIO(ID),
	CONSTRAINT FK_VENTA_SUCURSAL FOREIGN KEY (IDSUCURSAL) REFERENCES TBLSUCURSAL(ID),
	CONSTRAINT FK_VENTA_CLIENTE FOREIGN KEY (IDCLIENTE) REFERENCES TBLCLIENTE(ID),
);
GO


CREATE TABLE TBLDETALLE_VENTA
(
	ID INTEGER NOT NULL,
	CANTIDAD INTEGER NOT NULL,
	PRECIO MONEY NOT NULL,
	DESCUENTO MONEY NOT NULL,
	TOTAL MONEY NOT NULL,
	IDINVENTARIO INTEGER NOT NULL,
	IDVENTA INTEGER NOT NULL, 
	--IDPRODUCTO INTEGER NOT NULL, 
	CONSTRAINT PK_DETALLEVENTA PRIMARY KEY (ID, IDVENTA, IDINVENTARIO/*, IDPRODUCTO*/),
	CONSTRAINT FK_DETALLEVENTA_VENTA FOREIGN KEY (IDVENTA) REFERENCES TBLVENTA(ID),
	--CONSTRAINT FK_DETALLEVENTA_PRODUCTO FOREIGN KEY (IDPRODUCTO) REFERENCES TBLPRODUCTO(ID),
	CONSTRAINT FK_DETALLEVENTA_INVENTARIO FOREIGN KEY (IDINVENTARIO) REFERENCES TBLINVENTARIO(ID)
);
GO


CREATE TABLE TBLACCION
(
	ID INTEGER NOT NULL,
	NOMBRE VARCHAR(100) NOT NULL,
	DESCRIPCION VARCHAR(300) NULL,
	ESTADO BIT NOT NULL	CONSTRAINT CK_ESTADO_ACCION CHECK (ESTADO IN (0, 1)),
	CONSTRAINT PK_ACCION PRIMARY KEY(ID)
);


CREATE TABLE TBLPOSTVENTA
(
	ID INTEGER NOT NULL,
	CAUSA VARCHAR(500) NOT NULL,
	CANTIDAD INTEGER NOT NULL,
	PRECIO MONEY NOT NULL,
	TOTAL MONEY NOT NULL,
	IDACCION INTEGER NOT NULL,
	IDVENTA INTEGER NOT NULL,
	IDDETALLE_VENTA INTEGER NOT NULL,
	IDINVENTARIO INTEGER NOT NULL,
	CONSTRAINT PK_POSTVENTA PRIMARY KEY (ID),
	CONSTRAINT FK_POSTVENTA_ACCION FOREIGN KEY (IDACCION) REFERENCES TBLACCION(ID),
	CONSTRAINT FK_POSTVENTA_DETALLE FOREIGN KEY (IDDETALLE_VENTA, IDVENTA, IDINVENTARIO) REFERENCES TBLDETALLE_VENTA(ID, IDVENTA, IDINVENTARIO)
);

CREATE TABLE TBLCAMBIO
(
	ID INTEGER NOT NULL, 
	PRECIO MONEY NOT NULL,
	CANTIDAD INTEGER NOT NULL,
	TOTAL MONEY NOT NULL,
	DESCUENTO MONEY NOT NULL,
	IDPOST_VENTA INTEGER NOT NULL, 
	IDINVENTARIO INTEGER NOT NULL,
	CONSTRAINT PK_CAMBIO PRIMARY KEY (ID),
	CONSTRAINT FK_CAMBIO_POSTVENTA FOREIGN KEY (IDPOST_VENTA) REFERENCES TBLPOSTVENTA(ID),
	CONSTRAINT FK_CAMBIO_INVENTARIO FOREIGN KEY (IDINVENTARIO) REFERENCES TBLINVENTARIO(ID),
);


SELECT *
FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_TYPE = 'BASE TABLE' AND TABLE_CATALOG='ECOVISA'